-- 86.3gb, 2.46tb





USE stock;
SET GLOBAL innodb_buffer_pool_size=8053063680;




-- 44374493

SELECT *
FROM Encodings
WHERE migrated_SQL = 1
AND migrated_Mongo is NULL
LIMIT 10
;

Select *
FROM Images
WHERE image_id = 74173690
;

SELECT *
FROM Encodings i 
WHERE i.encoding_id = 125652553
;

SELECT *
FROM Images
WHERE site_image_id = 1375949586
AND site_name_id = 10
;

UPDATE encodings e
SET e.migrated_SQL = 1, e.is_face = NULL
WHERE e.is_face = 1 
AND e.bbox is NULL
AND e.migrated = 1
;



SELECT i.site_image_id, ib.lum_torso, ib.lum_torso_bb, ib.selfie_bbox
FROM ImagesBackground ib
JOIN Images i ON i.image_id = ib.image_id
WHERE i.site_image_id IN ('1374307379', '1321070633')
;

SELECT i.site_name_id, i.imagename, i.description
FROM Images i 
JOIN encodings 	e ON i.image_id = e.image_id
WHERE e.migrated_SQL = 1
AND e.is_face = NULL
AND i.site_name_id = 3
LIMIT 1

;


SELECT *
FROM Images i
WHERE i.image_id = 65761606
;

SELECT *
FROM Encodings
WHERE image_id = 2284907
;


SELECT *
FROM Images i 
WHERE i.site_name_id = 10
AND i.site_image_id = 800181355
;



SELECT DISTINCT(s.image_id), s.site_name_id, s.contentUrl, s.imagename, s.description, s.face_x, s.face_y, s.face_z, s.mouth_gap, s.bbox, s.site_image_id, ibg.lum, ibg.lum_bb, ibg.hue, 
ibg.hue_bb, ibg.sat, ibg.sat_bb, ibg.val, ibg.val_bb, ibg.lum_torso, ibg.lum_torso_bb  
;

SELECT COUNT(*)
FROM Encodings s  JOIN ImagesBodyPoses3D ihp ON s.image_id = ihp.image_id  
JOIN ClustersMetaBodyPoses3D cmp ON ihp.cluster_id = cmp.cluster_id  
JOIN ImagesKeywords it ON s.image_id = it.image_id  JOIN SegmentHelper_sept2025_heft_keywords sh ON s.image_id = sh.image_id  
JOIN ImagesBackground ibg ON s.image_id = ibg.image_id   JOIN ImagesHSV ihsv ON s.image_id = ihsv.image_id  
WHERE  s.is_dupe_of IS NULL  AND s.age_id NOT IN (1,2,3)  AND cmp.meta_cluster_id = 2   AND ihsv.cluster_id  = 13   AND 
it.keyword_id  IN (22101, 444, 22191, 16045, 11549, 133300, 133777, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411, 22411)  LIMIT 100000;

LIMIT 2500;

UPDATE SegmentBig_isface AS seg
JOIN Images AS img ON seg.image_id = img.image_id
SET seg.contentUrl = img.contentUrl, seg.imagename = img.imagename, seg.description = img.description, seg.site_image_id = img.site_image_id
WHERE seg.contentUrl IS NULL
AND img.contentUrl IS NOT NULL;


CREATE TABLE SegmentHelper_may2025_4x4faces (
    seg_image_id int NOT NULL AUTO_INCREMENT PRIMARY KEY,
    image_id INTEGER,
    FOREIGN KEY (image_id) REFERENCES Images(image_id)
);



DELETE FROM BodyPoses3D;
DELETE FROM ImagesBodyPoses3D;

DELETE FROM ArmsPoses3D;
DELETE FROM ImagesArmsPoses3D;


USE stock;
SELECT cluster_id, COUNT(image_id) 
FROM ImagesBodyPoses3D
GROUP BY cluster_id
ORDER BY cluster_id
;


CREATE TABLE BodyPoses3D (
    cluster_id int NOT NULL PRIMARY KEY,
    cluster_median BLOB
);

-- This is the poses junction table.
CREATE TABLE ImagesBodyPoses3D (
    image_id INTEGER REFERENCES Images (image_id),
    cluster_id INTEGER REFERENCES BodyPoses3D (cluster_id),
    cluster_dist FLOAT DEFAULT NULL,
    PRIMARY KEY (image_id)
);


CREATE TABLE ArmsPoses3D (
    cluster_id int NOT NULL PRIMARY KEY,
    cluster_median BLOB
);

-- This is the poses junction table.
CREATE TABLE ImagesArmsPoses3D (
    image_id INTEGER REFERENCES Images (image_id),
    cluster_id INTEGER REFERENCES ArmsPoses3D (cluster_id),
    cluster_dist FLOAT DEFAULT NULL,
    PRIMARY KEY (image_id)
);

SELECT COUNT(image_id)
FROM ImagesBodyPoses3D
;

CREATE TABLE MetaBodyPoses3D (
    cluster_id int NOT NULL PRIMARY KEY,
    cluster_median BLOB
);

-- This is the poses junction table.
CREATE TABLE ClustersMetaBodyPoses3D (
    cluster_id INTEGER REFERENCES BodyPoses3D (cluster_id),
    meta_cluster_id INTEGER REFERENCES MetaBodyPoses3D (cluster_id),
    cluster_dist FLOAT DEFAULT NULL,
    PRIMARY KEY (cluster_id)
);


-- This is the poses junction table.
CREATE TABLE ClustersMetaHSV (
    cluster_id INTEGER REFERENCES HSV (cluster_id),
    meta_cluster_id INTEGER,
    cluster_dist FLOAT DEFAULT NULL,
    cluster_name varchar(40),
    PRIMARY KEY (cluster_id)
);


SELECT * FROM ArmsPoses3D ;
SELECT * FROM ImagesArmsPoses3D ;

DELETE FROM HSV ;
DELETE FROM ImagesHSV ;

Use Stock;
DELETE FROM MetaBodyPoses3D ;
DELETE FROM ClustersMetaBodyPoses3D  ;

SELECT cmbp.meta_cluster_id, COUNT(cmbp.cluster_id)
FROM ClustersMetaBodyPoses3D cmbp 
GROUP BY cmbp.meta_cluster_id
ORDER BY cmbp.meta_cluster_id
;

SELECT *
FROM ClustersMetaBodyPoses3D
WHERE ClustersMetaBodyPoses3D.cluster_id =235 

SELECT COUNT(s.image_id) 
FROM SegmentBig_isnotface s  JOIN Encodings e ON s.image_id = e.image_id  
WHERE  e.is_dupe_of IS NULL  
AND e.mongo_body_landmarks_3D = 1 and e.is_feet = 1
 ;

SELECT cmb.meta_cluster_id, COUNT(cmb.cluster_id)
FROM ClustersMetaBodyPoses3D cmb
GROUP BY cmb.meta_cluster_id
ORDER BY cmb.meta_cluster_id
;


SELECT cmb.cluster_id, COUNT(cmb.image_id)
FROM ImagesBodyPoses3D cmb
JOIN Encodings e ON cmb.image_id = e.image_id
WHERE e.is_feet = 0
GROUP BY cmb.cluster_id
ORDER BY cmb.cluster_id
;

-- delete rows from ImagesBodyPoses3D where the joined Encodings row matches criteria
-- MySQL syntax: DELETE <alias> FROM <table> <alias> JOIN ... WHERE ...
DELETE cmb
FROM ImagesBodyPoses3D cmb
JOIN Encodings e ON cmb.image_id = e.image_id
WHERE e.is_feet = 1 AND e.mongo_hand_landmarks = 1;


USE stock;
SELECT cmb.meta_cluster_id, cmb.cluster_id
FROM ClustersMetaBodyPoses3D cmb
WHERE cmb.meta_cluster_id = 181
;


SELECT cmb.meta_cluster_id, cmb.cluster_id
FROM ClustersMetaBodyPoses3D cmb
WHERE cmb.cluster_id = 27
;

SELECT ib.cluster_id, COUNT(ib.image_id)
FROM ImagesBodyPoses3D ib
JOIN ImagesKeywords ik ON ib.image_id = ik.image_id 
JOIN Encodings i ON ib.image_id = i.image_id
WHERE ib.cluster_id in (97, 253, 261, 313, 379, 401, 467, 475, 501, 528, 605)
AND ik.keyword_id = 22412
AND i.is_feet = 1
GROUP BY ib.cluster_id
ORDER BY ib.cluster_id
;

-- phone arms finder
SELECT image_id, cluster_id
FROM ImagesArmsPoses3D
WHERE image_id in (91742095,113851048,108529478,93704686,96513629,14884264,107859628,112487677,91706738,113778292,108410656,103854102,108921234,49890799,109990688,107320342,86859827,78136519,15976423,107647585,101914896,87505459,112579941,66321682,91511567,91509758,112673663,112017325,111980401,112647472,105817365,91755014,107162894,105539146,112049402,112437133,87502997,112417759,112517130,110124103,101418257,112454199,97355633,107863964,107128988,15959522,93094986,110118654,92189086,87501666,110067474,35060347,107079124,37729312,13668505,86859075,110019677,16088986,107724189,110433540,15285795,94105031,108764936,110025436,108143010,107783460,101827586,114157085,112433646,107386028,83327881,110365025,105797176,93751086,112716569,107145685,10480768,112634482,110119101,50931386,114404403,112539811,109951590,41268075,107753459,110320297,87501675,113218558,109890806,106477652,16542925,108319010,108047691,6580437,110011851,113200405,93294340,108631574,13302217,105699109,113509252,16491998,107030806,112585880,37473869,110287750,87501582,10788657,37149784,113213328,107595594,99623614,92478464,108382273,108845062,45929554,4125876,110252140,107797079,110168653,110353477,87504830,112592016,112720928,82613768,111827629,93966336,108643843,108083260,114518853,107521295,112500953,60128096,105346933,92844868,110008601,103880488,112644251,91760685,107383825,107082162,108409059,107494323,107670933,107160739,108694217,105606924,107693273,97895069,107523309,107308468,112689729,107772509,107145485,83653178,82613736,93730154,36582958,90493616,110320882,114072864,107315377,107925428,86865717,112394980,108768664,41751613,92321172,107478687,11660416,112117164,107654156,112421806,113779201,113820935,110159068,113122136,103847664,33854559,107568783,114376605,114380528,108909512,36483125,103883356,113230003,107947359,36188366,37689094,91690144,107368813,60126816,110217593,41509411,83191841,112535088,113604227,107063832,85953147,102099897,107939834,112562815,110252568,107807251,109896132,107248459,110454952,112585256,85790397,110326695,60128052,108663222,9496980,37728163,110182428,107300373,110138831,103879076,38661544,105587029,101407017,112652805,110170232,107789543,110160623,108182665,37689490,42833835,11006349,107707748,113874700,107677674,6599116,108195924,96394199,112451128,107855734,107353513,110052524,107869096,100104802,102668249,114156637,113175703,109960838,92341435,109869819,91715964,107856993,107621363,54029796,113901773,107260126,7363810,107799814,110513895,109907800,110127076,46135783,107105545,108413805,90534709,42514177,110340301,90409806,86215857,12576541,15960573,37728193,112592701,113826158,110394498,108066515,44159942,105516025,86864800,112550073,91618588,112530695,113815501,92495779,113775130,101389217,110255339,109933590,110247053,113121440,107221389,103888428,60129231,109974583,109156672,42513972,122450809,105732826,110372240,110384138,113173198,105560536,100020921,107493939,110537289,93747921,111895966,110517962,112697454,48312972,48423789,107666547,112707053,105875593,110574194,107073280,114050692,112734063,15329223,107273638,109943894,10464280,110134329,122567124,110526743,87521742,114019265,112537635,91518393,110166487,87283116,60128581,91695672,110062577,110121688,113768418,101392759,110216010,102266301,45929545,93731910,10752456,108155845,39039939,93860334,114351180,107534570,108835545,83567059,108719719,113877149,107019988,114120689,110153386,109986716,113185934,108132004,108814867,110496887,113433798,108975762,105348487,107389293,110080199,82689173,114093169,108643809,109990178,112628315,107847786,93684748,113496545,30523314,113899363,86670665,7375383,103878363,15330455,111878238,107796580,102046392,113617581,51732403,90499564,46135825,107978987,110203324,107044802,109506870,50032028,110360916,110280964,110092642,101363232,15289124,108462900,86493899,109991577,107073690,107512051,109622569,107275157,107855451,92554567,113985393,36034763,101902739,87505457,101996866,114130760,112524714,112697346,86697561,107161349,112832349,101430276,107291301,112445801,105855854,111513494,110292149,113126974,107814184,112737863,111697214,108360823,90502315,110078148,105526705,37552529,109855291,101547650,37728263,103880139,107284789,37595573,16531787,107264004,93706622,101907330,107819583,107616551,101443340,107288228,107359397,86739226,93825163,50000658,96521536,91511651,108859886,101880046,110197586,107183263,109934699,113150527,107148057,107843192,109928251,107640122,37552387,110095826,96899402,113156297,91513580,83781656,37301266,105364648,86691390,107584942,88704720,111855935,99610888,107832013,110532271,60463722,108171978,107387524,108341068,3131739,107962057,48589146,105425816,110540755,102367663,102370952,97520155,15943547,107555897,83703838,82689162,91592065,110003808,83534858,101397808,107562147,109993797,114180052,87410684,109886141,113442191,60127944,112625994,10601667,108519330,112727530,109660732,92007249,107265345,107940759,109936033,86858617,112063596,42513839,102387527,110470208,107347361,111934292,3220627,101533129,110126386,109993360,91512844,107604768,90495713,110214330,108662542,112022464,111922473,90956744,110401108,105503892,93721837,10980373,87209794,112617133,110057169,112435916,107710544,107392214,93227666,4567033,107268739,101333009,107586126,91513728,15336870,110386663,82613788,107179580,110536064,107570639,103795768,92528599,113249274,107666569,59452229,92464367,41267822,109078536,111925812,113144231,114486691,107875180,113861140,114333537,66024599,110221845,37727693,107485467,45929525,107124820,109887951,92270504,107635395,100380322,107141262,82689167,15286844,49834060,108699718,46006534,90032675,91511601,105877375,113899086,113665131,40329386,96698815,85962656,107053750,109853213,112731257,113270107,113484334,107595567,40329553,107854058,102041484,92471384,107497388,110360858,110284904,42513750,105812058,101480114,107349200,108588143,107498466,109909433,112725321,114203367,107127294,109301099,93754610,16089699,114018091,109347597,113839573,108907547,111962748,109937909,108533577,82689156,113996045,92333167,93728016,5299221,113221705,15287631,15947963,112344574,108483151,83331015,78034140,107031745,107591702,87501692,113860131,93678464,83831588,110042297,97891351,113981891,110588069,91747238,113240334,93591471,110339601,23561219,4832175,107693171,108985417,92266079,85895389,108208626,110705237,113848323,12980337,109922197,112537965,108755798,49871842,107523183,113587910,92076413,110440699,60127938,92188783,103864817,86851758,60463720,107729998,100878993,113892175,35853414,114514619,111707395,110394935,107656681,112710573,6535138,107610117,86693820,111835914,91731622,86858623,87503293,111799342,97904859,93531535,54110975,13383910,113646677,105931537,101919508,114436698,110212854,107916506,112630667,110139800,93495395,93083064,112007384,107706542,105827580,109538282,81130377,110061058,101844618,107248253,107062409,33276310,38168161,92318167,112816341,107243745,114222870,108135340,112711088,38546878,84786968,108548976,87501598,92076324,113840494,108153145,110273702,111843738,107564512,112796493,93955726,110262367,110227863,91518792,87501660,107188885)
;

USE Stock;
SELECT i.site_name_id, i.imagename
FROM Images i
JOIN ImagesKeywords ik on i.image_id = ik.image_id
JOIN SegmentOct20 s on i.image_id = s.image_id
JOIN SegmentHelper_sept2025_heft_keywords sh on i.image_id = sh.image_id
WHERE ik.keyword_id = 4222
LIMIT 5000
;

-- select count of ArmsPoses3D for heft keywords
SELECT  ik.cluster_id, COUNT(ik.image_id)
FROM SegmentHelper_sept2025_heft_keywords h
JOIN ImagesArmsPoses3D ik ON h.image_id = ik.image_id 
GROUP BY ik.cluster_id
ORDER BY ik.cluster_id


-- select count of HSV for heft keywords
SELECT  ik.cluster_id, COUNT(ik.image_id)
FROM SegmentHelper_sept2025_heft_keywords h
JOIN ImagesHSV ik ON h.image_id = ik.image_id 
GROUP BY ik.cluster_id
ORDER BY ik.cluster_id
;

-- select count of keywords for heft keywords
SELECT  ik.keyword_id, k.keyword_text, COUNT(ik.image_id)
FROM SegmentHelper_sept2025_heft_keywords h
JOIN ImagesKeywords ik ON h.image_id = ik.image_id 
JOIN Keywords k ON k.keyword_id = ik.keyword_id 
GROUP BY ik.keyword_id
ORDER BY ik.keyword_id
;

USE Stock;
SELECT DISTINCT(s.image_id), s.site_name_id, s.contentUrl, s.imagename, s.description, s.face_x, s.face_y, s.face_z, s.mouth_gap, s.bbox, s.site_image_id, ibg.lum, ibg.lum_bb, 
ibg.hue, ibg.hue_bb, ibg.sat, ibg.sat_bb, ibg.val, ibg.val_bb, ibg.lum_torso, ibg.lum_torso_bb  
FROM SegmentBig_isface s  JOIN Encodings e ON s.image_id = e.image_id  JOIN ImagesBodyPoses3D ihp ON s.image_id = ihp.image_id  JOIN 
ClustersMetaBodyPoses3D cmp ON ihp.cluster_id = cmp.cluster_id  JOIN ImagesKeywords it ON s.image_id = it.image_id  
JOIN SegmentHelper_sept2025_heft_keywords sh ON s.image_id = sh.image_id  JOIN ImagesBackground ibg ON s.image_id = ibg.image_id   
JOIN ImagesHSV ihsv ON s.image_id = ihsv.image_id  WHERE  e.is_dupe_of IS NULL  AND s.face_x IS NOT NULL  AND s.age_id NOT IN (1,2,3)  
AND cmp.meta_cluster_id = 0   
AND it.keyword_id  IN (184)  AND it.keyword_id  IN (7969)  LIMIT 100;

SELECT DISTINCT a.image_id
FROM ImagesKeywords a
JOIN ImagesKeywords b USING (image_id)
WHERE a.keyword_id = 184
  AND b.keyword_id = 7969
LIMIT 100
;


SELECT h.image_id
FROM SegmentHelper_oct2025_every40 h
JOIN ImagesKeywords ik ON h.image_id = ik.image_id 
WHERE ik.keyword_id IN (22411,22101,444,22191,16045,11549,133300,133777)
LIMIT 100
;

-- 193, 149


